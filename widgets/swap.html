<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Swap Widget | BroFit</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="./shared/styles.css">

    <style>
        /* ====================================================================
           SWAP WIDGET SPECIFIC STYLES
           ================================================================== */

        .swap-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        /* Swap Card */
        .swap-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            backdrop-filter: blur(var(--glass-blur));
            margin-bottom: var(--space-lg);
        }

        /* Token Section */
        .token-section {
            margin-bottom: var(--space-md);
        }

        .section-header {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .token-selector:hover {
            border-color: var(--primary-green);
            background: rgba(62, 184, 95, 0.05);
        }

        .token-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), var(--primary-green-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .token-info {
            flex: 1;
        }

        .token-symbol {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .token-name {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        /* Amount Input */
        .amount-input {
            width: 100%;
            padding: var(--space-lg);
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            font-family: var(--font-mono);
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }

        .amount-input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px var(--primary-green-glow);
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-sm);
            font-size: var(--font-size-sm);
        }

        .balance-label {
            color: var(--text-tertiary);
        }

        .balance-value {
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        .max-button {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-base);
            margin-left: var(--space-sm);
        }

        .max-button:hover {
            background: var(--primary-green-light);
        }

        /* Swap Arrow */
        .swap-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: var(--space-md) 0;
        }

        .swap-arrow-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 20px;
        }

        .swap-arrow-button:hover {
            border-color: var(--primary-green);
            transform: rotate(180deg);
        }

        /* Swap Details */
        .swap-details {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .detail-value.positive {
            color: var(--primary-green);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .swap-container {
                padding: var(--space-md);
            }

            .swap-card {
                padding: var(--space-lg);
            }

            .amount-input {
                font-size: var(--font-size-xl);
            }
        }
    </style>
</head>
<body>
    <div class="swap-container">
        <!-- Header -->
        <div class="widget-header">
            <h1 class="widget-title">ðŸ”„ Token Swap</h1>
            <p class="widget-description">Exchange tokens across 180+ chains with best rates</p>
        </div>

        <!-- Swap Card -->
        <div class="swap-card">
            <!-- From Token -->
            <div class="token-section">
                <div class="section-header">From</div>
                <div class="token-selector" id="fromTokenSelector">
                    <div class="token-icon">ETH</div>
                    <div class="token-info">
                        <div class="token-symbol">ETH</div>
                        <div class="token-name">Ethereum</div>
                    </div>
                    <span>â–¼</span>
                </div>

                <input
                    type="text"
                    id="fromAmount"
                    class="amount-input"
                    placeholder="0.0"
                    inputmode="decimal"
                >
                <div class="balance-row">
                    <span class="balance-label">Balance: <span class="balance-value" id="fromBalance">0.0 ETH</span></span>
                    <button class="max-button" id="maxButton">MAX</button>
                </div>
            </div>

            <!-- Swap Arrow -->
            <div class="swap-arrow">
                <button class="swap-arrow-button" id="swapDirection">â¬‡</button>
            </div>

            <!-- To Token -->
            <div class="token-section">
                <div class="section-header">To (estimated)</div>
                <div class="token-selector" id="toTokenSelector">
                    <div class="token-icon">USDT</div>
                    <div class="token-info">
                        <div class="token-symbol">USDT</div>
                        <div class="token-name">Tether USD</div>
                    </div>
                    <span>â–¼</span>
                </div>

                <input
                    type="text"
                    id="toAmount"
                    class="amount-input"
                    placeholder="0.0"
                    readonly
                >
                <div class="balance-row">
                    <span class="balance-label">Balance: <span class="balance-value" id="toBalance">0.0 USDT</span></span>
                </div>
            </div>
        </div>

        <!-- Swap Details -->
        <div class="swap-details" id="swapDetails" style="display: none;">
            <div class="detail-row">
                <span class="detail-label">Rate</span>
                <span class="detail-value" id="swapRate">1 ETH = 3,000 USDT</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Price Impact</span>
                <span class="detail-value" id="priceImpact">< 0.01%</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Network Fee</span>
                <span class="detail-value" id="networkFee">~$5.00</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Route</span>
                <span class="detail-value" id="swapRoute">Uniswap V3</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Minimum Received</span>
                <span class="detail-value positive" id="minReceived">2,985 USDT</span>
            </div>
        </div>

        <!-- Swap Button -->
        <button class="btn btn-primary btn-lg w-full" id="swapButton" disabled>
            Connect Wallet to Swap
        </button>
    </div>

    <!-- Shared Utilities -->
    <script src="./shared/utils.js"></script>
    <script src="./shared/rocketx-api.js"></script>

    <!-- Swap Logic -->
    <script>
        /* ====================================================================
           SWAP STATE & CONFIGURATION
           ================================================================== */

        const SwapWidget = {
            // State
            fromToken: { symbol: 'ETH', name: 'Ethereum', decimals: 18 },
            toToken: { symbol: 'USDT', name: 'Tether USD', decimals: 6 },
            fromAmount: '',
            toAmount: '',
            walletAddress: null,
            swapQuote: null,

            /* ================================================================
               INITIALIZATION
               ============================================================== */

            async init() {
                console.log('ðŸ”„ Initializing Swap Widget...');

                // Check wallet
                this.walletAddress = await getWalletAddress();

                // Setup event listeners
                this.setupEventListeners();

                // Update UI
                this.updateWalletUI();

                console.log('âœ… Swap widget initialized');
            },

            /* ================================================================
               EVENT LISTENERS
               ============================================================== */

            setupEventListeners() {
                // Amount input
                const fromAmountInput = document.getElementById('fromAmount');
                fromAmountInput.addEventListener('input', debounce(() => {
                    this.fromAmount = fromAmountInput.value;
                    this.handleAmountChange();
                }, 500));

                // MAX button
                document.getElementById('maxButton').addEventListener('click', () => {
                    this.setMaxAmount();
                });

                // Swap direction button
                document.getElementById('swapDirection').addEventListener('click', () => {
                    this.swapTokens();
                });

                // Token selectors
                document.getElementById('fromTokenSelector').addEventListener('click', () => {
                    showNotification('Token selector coming soon!', 'info');
                });

                document.getElementById('toTokenSelector').addEventListener('click', () => {
                    showNotification('Token selector coming soon!', 'info');
                });

                // Swap button
                document.getElementById('swapButton').addEventListener('click', () => {
                    this.executeSwap();
                });
            },

            /* ================================================================
               WALLET UI
               ============================================================== */

            updateWalletUI() {
                const button = document.getElementById('swapButton');

                if (this.walletAddress) {
                    button.textContent = 'Enter Amount';
                    button.disabled = false;
                    // Load balances (mock data for now)
                    document.getElementById('fromBalance').textContent = '2.5 ETH';
                    document.getElementById('toBalance').textContent = '5,000 USDT';
                } else {
                    button.textContent = 'Connect Wallet to Swap';
                    button.disabled = true;
                }
            },

            /* ================================================================
               AMOUNT HANDLING
               ============================================================== */

            handleAmountChange() {
                const button = document.getElementById('swapButton');

                if (!this.fromAmount || parseFloat(this.fromAmount) <= 0) {
                    button.disabled = !this.walletAddress;
                    button.textContent = this.walletAddress ? 'Enter Amount' : 'Connect Wallet to Swap';
                    document.getElementById('swapDetails').style.display = 'none';
                    return;
                }

                if (!this.walletAddress) {
                    button.disabled = true;
                    button.textContent = 'Connect Wallet';
                    return;
                }

                // Enable swap and fetch quote
                button.disabled = false;
                button.textContent = \`Swap \${this.fromAmount} \${this.fromToken.symbol}\`;

                this.fetchSwapQuote();
            },

            setMaxAmount() {
                // Mock max balance
                const maxBalance = '2.5';
                document.getElementById('fromAmount').value = maxBalance;
                this.fromAmount = maxBalance;
                this.handleAmountChange();
            },

            swapTokens() {
                // Swap from and to tokens
                const temp = this.fromToken;
                this.fromToken = this.toToken;
                this.toToken = temp;

                // Update UI
                document.querySelector('#fromTokenSelector .token-icon').textContent = this.fromToken.symbol.substring(0, 3);
                document.querySelector('#fromTokenSelector .token-symbol').textContent = this.fromToken.symbol;
                document.querySelector('#fromTokenSelector .token-name').textContent = this.fromToken.name;

                document.querySelector('#toTokenSelector .token-icon').textContent = this.toToken.symbol.substring(0, 3);
                document.querySelector('#toTokenSelector .token-symbol').textContent = this.toToken.symbol;
                document.querySelector('#toTokenSelector .token-name').textContent = this.toToken.name;

                // Recalculate if amount entered
                if (this.fromAmount) {
                    this.fetchSwapQuote();
                }
            },

            /* ================================================================
               SWAP QUOTE
               ============================================================== */

            async fetchSwapQuote() {
                try {
                    // Show loading
                    document.getElementById('toAmount').value = 'Loading...';

                    // Mock quote (would use RocketX API in production)
                    const quote = await this.getMockQuote();

                    this.swapQuote = quote;
                    this.toAmount = quote.outputAmount;

                    // Update UI
                    document.getElementById('toAmount').value = quote.outputAmount;
                    document.getElementById('swapRate').textContent = quote.rate;
                    document.getElementById('priceImpact').textContent = quote.priceImpact;
                    document.getElementById('networkFee').textContent = quote.networkFee;
                    document.getElementById('swapRoute').textContent = quote.route;
                    document.getElementById('minReceived').textContent = quote.minReceived;

                    // Show details
                    document.getElementById('swapDetails').style.display = 'block';

                } catch (error) {
                    console.error('Failed to fetch swap quote:', error);
                    showNotification('Failed to get quote', 'error');
                }
            },

            getMockQuote() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const amount = parseFloat(this.fromAmount);
                        const outputAmount = (amount * 3000).toFixed(2);
                        const minReceived = (amount * 2985).toFixed(2);

                        resolve({
                            outputAmount,
                            rate: \`1 \${this.fromToken.symbol} = 3,000 \${this.toToken.symbol}\`,
                            priceImpact: '< 0.01%',
                            networkFee: '~$5.00',
                            route: 'Uniswap V3',
                            minReceived: \`\${minReceived} \${this.toToken.symbol}\`
                        });
                    }, 1000);
                });
            },

            /* ================================================================
               SWAP EXECUTION
               ============================================================== */

            async executeSwap() {
                if (!this.walletAddress) {
                    showNotification('Please connect your wallet', 'warning');
                    return;
                }

                if (!this.fromAmount || parseFloat(this.fromAmount) <= 0) {
                    showNotification('Please enter an amount', 'warning');
                    return;
                }

                try {
                    showNotification('Initiating swap...', 'info');

                    // Mock swap execution
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    showNotification(\`Successfully swapped \${this.fromAmount} \${this.fromToken.symbol} for \${this.toAmount} \${this.toToken.symbol}!\`, 'success');

                    // Save to transaction history
                    if (typeof rocketxAPI !== 'undefined') {
                        rocketxAPI.saveTransactionLocal(this.walletAddress, {
                            type: 'swap',
                            fromToken: this.fromToken.symbol,
                            toToken: this.toToken.symbol,
                            fromAmount: this.fromAmount,
                            toAmount: this.toAmount,
                            status: 'completed',
                            timestamp: Date.now()
                        });
                    }

                    // Reset form
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                    this.fromAmount = '';
                    this.toAmount = '';
                    document.getElementById('swapDetails').style.display = 'none';

                } catch (error) {
                    console.error('Swap failed:', error);
                    showNotification(parseWeb3Error(error), 'error');
                }
            }
        };

        /* ====================================================================
           INITIALIZE ON PAGE LOAD
           ================================================================== */

        document.addEventListener('DOMContentLoaded', () => {
            SwapWidget.init();
        });

        // Listen for wallet connection changes from parent dashboard
        window.addEventListener('message', (event) => {
            if (event.data.type === 'wallet_connected') {
                SwapWidget.walletAddress = event.data.address;
                SwapWidget.updateWalletUI();
            }
        });
    </script>
</body>
</html>
