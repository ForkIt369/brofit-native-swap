<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Swap Widget | BroFit</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="./shared/styles.css">
    <link rel="stylesheet" href="./shared/loading-skeleton.css">

    <style>
        /* ====================================================================
           SWAP WIDGET SPECIFIC STYLES
           ================================================================== */

        .swap-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        /* Swap Card */
        .swap-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            backdrop-filter: blur(var(--glass-blur));
            margin-bottom: var(--space-lg);
        }

        /* Token Section */
        .token-section {
            margin-bottom: var(--space-md);
        }

        .section-header {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .token-selector:hover {
            border-color: var(--primary-green);
            background: rgba(62, 184, 95, 0.05);
        }

        .token-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            color: var(--text-secondary);
            font-size: 16px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .token-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .token-icon-text {
            font-size: 14px;
            font-weight: var(--font-weight-bold);
            color: white;
        }

        .token-info {
            flex: 1;
        }

        .token-symbol {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .token-name {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        /* Amount Input */
        .amount-input {
            width: 100%;
            padding: var(--space-lg);
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            font-family: var(--font-mono);
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }

        .amount-input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px var(--primary-green-glow);
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-sm);
            font-size: var(--font-size-sm);
        }

        .balance-label {
            color: var(--text-tertiary);
        }

        .balance-value {
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        .max-button {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-base);
            margin-left: var(--space-sm);
        }

        .max-button:hover {
            background: var(--primary-green-light);
        }

        /* Swap Arrow */
        .swap-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: var(--space-md) 0;
        }

        .swap-arrow-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 20px;
        }

        .swap-arrow-button:hover {
            border-color: var(--primary-green);
            transform: rotate(180deg);
        }

        /* Swap Details */
        .swap-details {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .detail-value.positive {
            color: var(--primary-green);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .swap-container {
                padding: var(--space-md);
            }

            .swap-card {
                padding: var(--space-lg);
            }

            .amount-input {
                font-size: var(--font-size-xl);
            }
        }

        /* Token Selector Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .token-modal {
            background: var(--bg-primary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--transition-base);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-search {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--glass-border);
        }

        .search-input {
            width: 100%;
            padding: var(--space-md);
            font-size: var(--font-size-base);
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }

        .search-input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px var(--primary-green-glow);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        .token-list-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .token-list-item:hover {
            background: var(--bg-tertiary);
        }

        .token-list-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            color: var(--text-secondary);
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .token-list-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .token-list-info {
            flex: 1;
        }

        .token-list-symbol {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .token-list-name {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
        }

        .loading-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .no-results {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-tertiary);
        }
    </style>
</head>
<body>
    <!-- Token Selector Modal -->
    <div class="modal-overlay" id="tokenModal">
        <div class="token-modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Token</h3>
                <button class="modal-close" id="closeModal">×</button>
            </div>
            <div class="modal-search">
                <input
                    type="text"
                    id="tokenSearch"
                    class="search-input"
                    placeholder="Search by name or address..."
                >
            </div>
            <div class="modal-body" id="tokenList">
                <div class="loading-state">Loading tokens...</div>
            </div>
        </div>
    </div>

    <div class="swap-container">
        <!-- Header -->
        <div class="widget-header">
            <h1 class="widget-title">🔄 Token Swap</h1>
            <p class="widget-description">Exchange tokens across 10 supported chains with best rates</p>
        </div>

        <!-- Swap Card -->
        <div class="swap-card">
            <!-- From Token -->
            <div class="token-section">
                <div class="section-header">From</div>
                <div class="token-selector" id="fromTokenSelector">
                    <div class="token-icon" id="fromTokenIcon">
                        <span class="token-icon-text">ETH</span>
                    </div>
                    <div class="token-info">
                        <div class="token-symbol">ETH</div>
                        <div class="token-name">Ethereum</div>
                    </div>
                    <span>▼</span>
                </div>

                <input
                    type="text"
                    id="fromAmount"
                    class="amount-input"
                    placeholder="0.0"
                    inputmode="decimal"
                >
                <div class="balance-row">
                    <span class="balance-label">Balance: <span class="balance-value" id="fromBalance">0.0 ETH</span></span>
                    <button class="max-button" id="maxButton">MAX</button>
                </div>
            </div>

            <!-- Swap Arrow -->
            <div class="swap-arrow">
                <button class="swap-arrow-button" id="swapDirection">⬇</button>
            </div>

            <!-- To Token -->
            <div class="token-section">
                <div class="section-header">To (estimated)</div>
                <div class="token-selector" id="toTokenSelector">
                    <div class="token-icon" id="toTokenIcon">
                        <span class="token-icon-text">USDT</span>
                    </div>
                    <div class="token-info">
                        <div class="token-symbol">USDT</div>
                        <div class="token-name">Tether USD</div>
                    </div>
                    <span>▼</span>
                </div>

                <input
                    type="text"
                    id="toAmount"
                    class="amount-input"
                    placeholder="0.0"
                    readonly
                >
                <div class="balance-row">
                    <span class="balance-label">Balance: <span class="balance-value" id="toBalance">0.0 USDT</span></span>
                </div>
            </div>
        </div>

        <!-- Swap Details -->
        <div class="swap-details" id="swapDetails" style="display: none;">
            <div class="detail-row">
                <span class="detail-label">Rate</span>
                <span class="detail-value" id="swapRate">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Price Impact</span>
                <span class="detail-value" id="priceImpact">< 0.01%</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Network Fee</span>
                <span class="detail-value" id="networkFee">~$5.00</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Route</span>
                <span class="detail-value" id="swapRoute">Uniswap V3</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Minimum Received</span>
                <span class="detail-value positive" id="minReceived">2,985 USDT</span>
            </div>
            <div class="detail-row" id="savingsRow" style="display: none;">
                <span class="detail-label">Savings vs Worst Route</span>
                <span class="detail-value positive" id="swapSavings">$0.00</span>
            </div>
            <div class="detail-row" id="timeRow" style="display: none;">
                <span class="detail-label">Estimated Time</span>
                <span class="detail-value" id="swapTime">~50s</span>
            </div>
        </div>

        <!-- Swap Button -->
        <button class="btn btn-primary btn-lg w-full" id="swapButton" disabled>
            Connect Wallet to Swap
        </button>
    </div>

    <!-- Shared Utilities -->
    <script src="./shared/utils.js"></script>
    <script src="./shared/rocketx-api.js"></script>

    <!-- Swap Logic -->
    <script>
        /* ====================================================================
           TOKEN CONFIGURATION WITH ADDRESSES
           ================================================================== */

        const TOKEN_CONFIG = {
            'ETH': {
                symbol: 'ETH',
                name: 'Ethereum',
                decimals: 18,
                address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE', // Native ETH placeholder
                chainId: '0x1', // Ethereum mainnet
                coingeckoId: 'ethereum'
            },
            'WETH': {
                symbol: 'WETH',
                name: 'Wrapped Ether',
                decimals: 18,
                address: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',
                chainId: '0x1',
                coingeckoId: 'weth'
            },
            'USDT': {
                symbol: 'USDT',
                name: 'Tether USD',
                decimals: 6,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                chainId: '0x1',
                coingeckoId: 'tether'
            },
            'USDC': {
                symbol: 'USDC',
                name: 'USD Coin',
                decimals: 6,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                chainId: '0x1',
                coingeckoId: 'usd-coin'
            },
            'DAI': {
                symbol: 'DAI',
                name: 'Dai Stablecoin',
                decimals: 18,
                address: '0x6B175474E89094C44Da98b954EedeAC495271d0F',
                chainId: '0x1',
                coingeckoId: 'dai'
            },
            'WBTC': {
                symbol: 'WBTC',
                name: 'Wrapped Bitcoin',
                decimals: 8,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                chainId: '0x1',
                coingeckoId: 'wrapped-bitcoin'
            },
            'BTC': {
                symbol: 'BTC',
                name: 'Bitcoin',
                decimals: 8,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599', // Use WBTC on Ethereum
                chainId: '0x1',
                coingeckoId: 'bitcoin'
            }
        };

        /**
         * Network name mapper - converts hex chainIds to RocketX network names
         * Based on RocketX Telegram support examples
         */
        const NETWORK_MAP = {
            '0x1': 'ethereum',
            '0x38': 'binance',
            '0x89': 'polygon',
            '0xa': 'optimism',
            '0x2105': 'Base Chain',  // Base (can have spaces!)
            '0xa4b1': 'arbitrum',
            '0x144': 'zksync',
            '0xe708': 'linea',
            '0xa86a': 'avalanche',
            '0xfa': 'fantom',
            '0x64': 'gnosis',
            '0x13881': 'polygon_mumbai',
            '0xaa36a7': 'sepolia'
        };

        /* ====================================================================
           SWAP STATE & CONFIGURATION
           ================================================================== */

        const SwapWidget = {
            // State
            fromToken: TOKEN_CONFIG['ETH'],
            toToken: TOKEN_CONFIG['USDT'],
            fromAmount: '',
            toAmount: '',
            walletAddress: null,
            swapQuote: null,

            /* ================================================================
               INITIALIZATION
               ============================================================== */

            async init() {
                console.log('🔄 Initializing Swap Widget...');

                // Check wallet - try multiple methods for iframe context
                this.walletAddress = await this.getWalletAddressSafe();

                // Setup event listeners
                this.setupEventListeners();

                // Update UI
                this.updateWalletUI();

                // Render initial token icons
                this.updateTokenIcon('from', this.fromToken);
                this.updateTokenIcon('to', this.toToken);

                console.log('✅ Swap widget initialized', { wallet: this.walletAddress });
            },

            /**
             * Safe wallet address getter for iframe context
             */
            async getWalletAddressSafe() {
                // Method 1: Try getWalletAddress() utility
                const walletFromUtils = await getWalletAddress();
                if (walletFromUtils) {
                    console.log('✅ Wallet detected via utils:', walletFromUtils);
                    return walletFromUtils;
                }

                // Method 2: Check localStorage (parent may have saved it)
                const savedWallet = localStorage.getItem('brofit_wallet_address');
                if (savedWallet) {
                    console.log('✅ Wallet detected via localStorage:', savedWallet);
                    return savedWallet;
                }

                // Method 3: Check if parent posted wallet via postMessage
                // (Will be set via message listener)
                console.log('⏳ No wallet detected yet, waiting for connection...');
                return null;
            },

            /* ================================================================
               EVENT LISTENERS
               ============================================================== */

            setupEventListeners() {
                // Amount input
                const fromAmountInput = document.getElementById('fromAmount');
                fromAmountInput.addEventListener('input', debounce(() => {
                    this.fromAmount = fromAmountInput.value;
                    this.handleAmountChange();
                }, 500));

                // MAX button
                document.getElementById('maxButton').addEventListener('click', () => {
                    this.setMaxAmount();
                });

                // Swap direction button
                document.getElementById('swapDirection').addEventListener('click', () => {
                    this.swapTokens();
                });

                // Token selectors
                document.getElementById('fromTokenSelector').addEventListener('click', () => {
                    this.openTokenSelector('from');
                });

                document.getElementById('toTokenSelector').addEventListener('click', () => {
                    this.openTokenSelector('to');
                });

                // Modal close
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeTokenSelector();
                });

                // Click outside modal to close
                document.getElementById('tokenModal').addEventListener('click', (e) => {
                    if (e.target.id === 'tokenModal') {
                        this.closeTokenSelector();
                    }
                });

                // Token search
                document.getElementById('tokenSearch').addEventListener('input', debounce((e) => {
                    this.filterTokens(e.target.value);
                }, 300));

                // Swap button
                document.getElementById('swapButton').addEventListener('click', () => {
                    this.executeSwap();
                });
            },

            /* ================================================================
               WALLET UI
               ============================================================== */

            updateWalletUI() {
                const button = document.getElementById('swapButton');

                if (this.walletAddress) {
                    button.textContent = 'Enter Amount';
                    button.disabled = false;
                    // Load balances (mock data for now)
                    document.getElementById('fromBalance').textContent = '2.5 ETH';
                    document.getElementById('toBalance').textContent = '5,000 USDT';
                    console.log('✅ Wallet UI updated - connected');
                } else {
                    button.textContent = 'Connect Wallet to Swap';
                    button.disabled = true;
                    console.log('⏳ Wallet UI updated - not connected');
                }
            },

            /**
             * Update token icon with proper image rendering
             */
            updateTokenIcon(direction, token) {
                const iconElement = document.getElementById(`${direction}TokenIcon`);
                if (!iconElement) return;

                const iconUrl = getTokenIconUrl(token);
                const symbolText = token.symbol.substring(0, Math.min(4, token.symbol.length)).toUpperCase();

                // Try to load image first
                const img = new Image();
                img.onload = () => {
                    iconElement.innerHTML = `<img src="${iconUrl}" alt="${token.symbol}" />`;
                };
                img.onerror = () => {
                    // Fallback to text
                    iconElement.innerHTML = `<span class="token-icon-text">${symbolText}</span>`;
                };
                img.src = iconUrl;
            },

            /* ================================================================
               AMOUNT HANDLING
               ============================================================== */

            handleAmountChange() {
                const button = document.getElementById('swapButton');

                if (!this.fromAmount || parseFloat(this.fromAmount) <= 0) {
                    button.disabled = !this.walletAddress;
                    button.textContent = this.walletAddress ? 'Enter Amount' : 'Connect Wallet to Swap';
                    document.getElementById('swapDetails').style.display = 'none';
                    return;
                }

                if (!this.walletAddress) {
                    button.disabled = true;
                    button.textContent = 'Connect Wallet';
                    return;
                }

                // Enable swap and fetch quote
                button.disabled = false;
                button.textContent = `Swap ${this.fromAmount} ${this.fromToken.symbol}`;

                this.fetchSwapQuote();
            },

            setMaxAmount() {
                // Mock max balance
                const maxBalance = '2.5';
                document.getElementById('fromAmount').value = maxBalance;
                this.fromAmount = maxBalance;
                this.handleAmountChange();
            },

            swapTokens() {
                // Swap from and to tokens
                const temp = this.fromToken;
                this.fromToken = this.toToken;
                this.toToken = temp;

                // Update UI with proper icon rendering
                this.updateTokenIcon('from', this.fromToken);
                this.updateTokenIcon('to', this.toToken);

                document.querySelector('#fromTokenSelector .token-symbol').textContent = this.fromToken.symbol;
                document.querySelector('#fromTokenSelector .token-name').textContent = this.fromToken.name;

                document.querySelector('#toTokenSelector .token-symbol').textContent = this.toToken.symbol;
                document.querySelector('#toTokenSelector .token-name').textContent = this.toToken.name;

                // Recalculate if amount entered
                if (this.fromAmount) {
                    this.fetchSwapQuote();
                }

                console.log('🔄 Tokens swapped:', this.fromToken.symbol, '↔️', this.toToken.symbol);
            },

            /* ================================================================
               SWAP QUOTE
               ============================================================== */

            async fetchSwapQuote() {
                try {
                    // Show loading
                    document.getElementById('toAmount').value = 'Loading...';

                    // Fetch quote (real API with fallback to mock)
                    const quote = await this.fetchSwapQuoteWithAPI();

                    this.swapQuote = quote;
                    this.toAmount = quote.outputAmount;

                    // Update UI
                    document.getElementById('toAmount').value = quote.outputAmount;
                    document.getElementById('swapRate').textContent = quote.rate;
                    document.getElementById('priceImpact').textContent = quote.priceImpact;
                    document.getElementById('networkFee').textContent = quote.networkFee;
                    document.getElementById('swapRoute').textContent = quote.route;
                    document.getElementById('minReceived').textContent = quote.minReceived;

                    // Show RocketX-specific fields if available
                    if (quote.savings) {
                        document.getElementById('swapSavings').textContent = quote.savings;
                        document.getElementById('savingsRow').style.display = 'flex';
                    } else {
                        document.getElementById('savingsRow').style.display = 'none';
                    }

                    if (quote.estimatedTime) {
                        document.getElementById('swapTime').textContent = quote.estimatedTime;
                        document.getElementById('timeRow').style.display = 'flex';
                    } else {
                        document.getElementById('timeRow').style.display = 'none';
                    }

                    // Show details
                    document.getElementById('swapDetails').style.display = 'block';

                } catch (error) {
                    console.error('Failed to fetch swap quote:', error);
                    showNotification('Failed to get quote', 'error');
                    document.getElementById('toAmount').value = '0.0';
                }
            },

            async fetchSwapQuoteWithAPI() {
                try {
                    console.log('📊 Fetching quotes from RocketX quotation API...');

                    // Map chainIds to network names
                    const fromNetwork = NETWORK_MAP[this.fromToken.chainId] || 'ethereum';
                    const toNetwork = NETWORK_MAP[this.toToken.chainId] || 'ethereum';

                    // RocketX uses human-readable amounts, not wei
                    const amount = this.fromAmount;

                    // For native tokens (ETH, BNB, etc), use lowercase address
                    const fromToken = this.fromToken.address.toLowerCase();
                    const toToken = this.toToken.address.toLowerCase();

                    console.log('📊 RocketX quotation request:', {
                        from: `${this.fromToken.symbol} on ${fromNetwork}`,
                        to: `${this.toToken.symbol} on ${toNetwork}`,
                        amount: amount,
                        fromToken: fromToken,
                        toToken: toToken
                    });

                    // Call new GET quotation endpoint
                    const response = await fetch(
                        `/api/rocketx/quotation?` +
                        `fromToken=${encodeURIComponent(fromToken)}` +
                        `&fromNetwork=${encodeURIComponent(fromNetwork)}` +
                        `&toToken=${encodeURIComponent(toToken)}` +
                        `&toNetwork=${encodeURIComponent(toNetwork)}` +
                        `&amount=${encodeURIComponent(amount)}` +
                        `&slippage=1`
                    );

                    if (!response.ok) {
                        throw new Error(`RocketX quotation API error: ${response.status}`);
                    }

                    const data = await response.json();

                    console.log('✅ RocketX quotation response:', data);

                    // Check if we have quotes
                    if (!data.quotes || data.quotes.length === 0) {
                        throw new Error('No quotes available from RocketX');
                    }

                    // Filter only allowed transactions and sort by savings (best first)
                    const validQuotes = data.quotes
                        .filter(q => q.isTxnAllowed === true)
                        .sort((a, b) =>
                            (b.additionalInfo?.savingUsd || 0) -
                            (a.additionalInfo?.savingUsd || 0)
                        );

                    if (validQuotes.length === 0) {
                        throw new Error('No valid quotes available');
                    }

                    // Get the best quote (highest savings)
                    const bestQuote = validQuotes[0];

                    console.log(`✅ Best quote: ${bestQuote.exchangeInfo.title} (saves $${bestQuote.additionalInfo.savingUsd.toFixed(2)})`);

                    // Format for UI
                    const quote = {
                        outputAmount: bestQuote.toAmount.toFixed(6),
                        rate: `1 ${this.fromToken.symbol} = ${bestQuote.toAmount.toLocaleString(undefined, {maximumFractionDigits: 2})} ${this.toToken.symbol}`,
                        priceImpact: `${(bestQuote.additionalInfo.priceImpact * 100).toFixed(4)}%`,
                        networkFee: `$${bestQuote.gasFeeUsd.toFixed(2)}`,
                        route: `${bestQuote.exchangeInfo.title} (${bestQuote.exchangeInfo.exchange_type})`,
                        minReceived: `${bestQuote.additionalInfo.minRecieved.toFixed(6)} ${this.toToken.symbol}`,
                        savings: `$${bestQuote.additionalInfo.savingUsd.toFixed(2)}`,
                        estimatedTime: `~${bestQuote.estTimeInSeconds.avg}s`,
                        // Store full quote for swap execution
                        _fullQuote: bestQuote
                    };

                    console.log('✅ Formatted quote for UI:', quote);
                    return quote;

                } catch (apiError) {
                    console.warn('⚠️ RocketX quotation API failed, using CoinGecko fallback:', apiError.message);
                    return await this.getMockQuote();
                }
            },

            /**
             * Convert human-readable amount to wei (smallest unit)
             */
            convertToWei(amount, decimals) {
                const num = parseFloat(amount);
                if (isNaN(num) || num <= 0) return '0';

                // Multiply by 10^decimals
                const multiplier = Math.pow(10, decimals);
                const wei = Math.floor(num * multiplier);

                return wei.toString();
            },

            /**
             * Convert wei (smallest unit) to human-readable amount
             */
            convertFromWei(amountInWei, decimals) {
                const num = parseFloat(amountInWei);
                if (isNaN(num) || num <= 0) return '0';

                // Divide by 10^decimals
                const divisor = Math.pow(10, decimals);
                const readable = num / divisor;

                return readable.toString();
            },

            async getMockQuote() {
                const amount = parseFloat(this.fromAmount);

                try {
                    // ✅ Use LIVE prices from CoinGecko backend API instead of hardcoded fake data
                    console.log('📊 Fetching live price from CoinGecko fallback...');

                    // Use coingeckoId from token config
                    const fromCoinId = this.fromToken.coingeckoId || 'ethereum';
                    const toCoinId = this.toToken.coingeckoId || 'tether';

                    const response = await fetch(`/api/coingecko/simple/price?ids=${fromCoinId},${toCoinId}&vs_currencies=usd`);

                    if (!response.ok) {
                        throw new Error(`CoinGecko API error: ${response.status}`);
                    }

                    const priceData = await response.json();
                    const fromPrice = priceData[fromCoinId]?.usd || 0;
                    const toPrice = priceData[toCoinId]?.usd || 1;

                    if (fromPrice === 0) {
                        throw new Error('Unable to fetch live price for ' + this.fromToken.symbol);
                    }

                    // Calculate real exchange rate
                    const liveRate = fromPrice / toPrice;
                    const outputAmount = (amount * liveRate).toFixed(6);
                    const minReceived = (amount * liveRate * 0.99).toFixed(6); // 1% slippage buffer

                    console.log(`✅ Live rate: 1 ${this.fromToken.symbol} = ${liveRate.toLocaleString()} ${this.toToken.symbol}`);

                    return {
                        outputAmount,
                        rate: `1 ${this.fromToken.symbol} = ${liveRate.toLocaleString(undefined, {maximumFractionDigits: 2})} ${this.toToken.symbol}`,
                        priceImpact: 'Unknown',
                        networkFee: 'Estimate unavailable',
                        route: 'CoinGecko Spot Price (Fallback)',
                        minReceived: `${minReceived} ${this.toToken.symbol}`
                    };

                } catch (error) {
                    console.error('❌ CoinGecko fallback failed:', error);
                    showNotification('⚠️ Unable to fetch live prices. Please try again.', 'error', window.BRO_CONSTANTS?.NOTIFICATION_DURATION?.EXTENDED || 8000);

                    // Don't return fake data - return error state
                    throw new Error('Price API unavailable');
                }
            },

            /* ================================================================
               TOKEN SELECTOR
               ============================================================== */

            allTokens: [],
            filteredTokens: [],
            currentSelector: null, // 'from' or 'to'

            async openTokenSelector(direction) {
                this.currentSelector = direction;
                const modal = document.getElementById('tokenModal');
                const tokenList = document.getElementById('tokenList');
                const searchInput = document.getElementById('tokenSearch');

                // Show modal
                modal.classList.add('active');
                searchInput.value = '';
                tokenList.innerHTML = '<div class="loading-state">Loading tokens...</div>';

                try {
                    // Fetch tokens from RocketX API
                    if (!this.allTokens.length && typeof rocketxAPI !== 'undefined') {
                        console.log('🔍 Fetching tokens from RocketX API...');
                        let rawTokens = await rocketxAPI.getTokens('ethereum');

                        // Normalize tokens to include chainId
                        this.allTokens = rawTokens.map(token => ({
                            ...token,
                            chainId: token.chainId || '0x1', // Default to Ethereum mainnet
                            coingeckoId: TOKEN_CONFIG[token.symbol]?.coingeckoId || null
                        }));

                        // Add some popular tokens if API doesn't return data
                        if (!this.allTokens || this.allTokens.length === 0) {
                            this.allTokens = this.getPopularTokens();
                        }

                        console.log(`✅ Loaded ${this.allTokens.length} tokens`);
                    }

                    this.filteredTokens = this.allTokens;
                    this.renderTokenList();

                } catch (error) {
                    console.error('Failed to load tokens:', error);
                    // Fallback to popular tokens
                    this.allTokens = this.getPopularTokens();
                    this.filteredTokens = this.allTokens;
                    this.renderTokenList();
                }
            },

            closeTokenSelector() {
                document.getElementById('tokenModal').classList.remove('active');
                this.currentSelector = null;
            },

            filterTokens(query) {
                const lowerQuery = query.toLowerCase().trim();

                if (!lowerQuery) {
                    this.filteredTokens = this.allTokens;
                } else {
                    this.filteredTokens = this.allTokens.filter(token =>
                        token.symbol?.toLowerCase().includes(lowerQuery) ||
                        token.name?.toLowerCase().includes(lowerQuery) ||
                        token.address?.toLowerCase().includes(lowerQuery)
                    );
                }

                this.renderTokenList();
            },

            renderTokenList() {
                const tokenList = document.getElementById('tokenList');

                if (!this.filteredTokens || this.filteredTokens.length === 0) {
                    tokenList.innerHTML = '<div class="no-results">No tokens found</div>';
                    return;
                }

                tokenList.innerHTML = this.filteredTokens.slice(0, 50).map(token => {
                    const iconUrl = getTokenIconUrl(token);
                    const symbolText = token.symbol.substring(0, Math.min(4, token.symbol.length)).toUpperCase();

                    return `
                        <div class="token-list-item" data-token='${JSON.stringify(token).replace(/'/g, '&apos;')}'>
                            <div class="token-list-icon">
                                <img
                                    src="${iconUrl}"
                                    alt="${token.symbol}"
                                    onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=&quot;token-icon-text&quot;>${symbolText}</span>';"
                                />
                            </div>
                            <div class="token-list-info">
                                <div class="token-list-symbol">${token.symbol}</div>
                                <div class="token-list-name">${token.name || 'Unknown'}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add click listeners
                tokenList.querySelectorAll('.token-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const token = JSON.parse(item.getAttribute('data-token'));
                        this.selectToken(token);
                    });
                });
            },

            selectToken(token) {
                if (this.currentSelector === 'from') {
                    this.fromToken = token;
                    this.updateTokenIcon('from', token);
                    document.querySelector('#fromTokenSelector .token-symbol').textContent = token.symbol;
                    document.querySelector('#fromTokenSelector .token-name').textContent = token.name || 'Unknown';
                } else if (this.currentSelector === 'to') {
                    this.toToken = token;
                    this.updateTokenIcon('to', token);
                    document.querySelector('#toTokenSelector .token-symbol').textContent = token.symbol;
                    document.querySelector('#toTokenSelector .token-name').textContent = token.name || 'Unknown';
                }

                this.closeTokenSelector();

                // Recalculate quote if amount is entered
                if (this.fromAmount) {
                    this.fetchSwapQuote();
                }

                console.log('✅ Token selected:', token.symbol);
            },

            getPopularTokens() {
                // Use TOKEN_CONFIG to ensure consistent format with chainId
                return Object.values(TOKEN_CONFIG);
            },

            /* ================================================================
               SWAP EXECUTION
               ============================================================== */

            async executeSwap() {
                if (!this.walletAddress) {
                    showNotification('Please connect your wallet', 'warning');
                    return;
                }

                if (!this.fromAmount || parseFloat(this.fromAmount) <= 0) {
                    showNotification('Please enter an amount', 'warning');
                    return;
                }

                try {
                    showNotification('Initiating swap...', 'info');

                    // Mock swap execution
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    showNotification(`Successfully swapped ${this.fromAmount} ${this.fromToken.symbol} for ${this.toAmount} ${this.toToken.symbol}!`, 'success');

                    // Save to transaction history
                    if (typeof rocketxAPI !== 'undefined') {
                        rocketxAPI.saveTransactionLocal(this.walletAddress, {
                            type: 'swap',
                            fromToken: this.fromToken.symbol,
                            toToken: this.toToken.symbol,
                            fromAmount: this.fromAmount,
                            toAmount: this.toAmount,
                            status: 'completed',
                            timestamp: Date.now()
                        });
                    }

                    // Reset form
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                    this.fromAmount = '';
                    this.toAmount = '';
                    document.getElementById('swapDetails').style.display = 'none';

                } catch (error) {
                    console.error('Swap failed:', error);
                    showNotification(parseWeb3Error(error), 'error');
                }
            }
        };

        /* ====================================================================
           INITIALIZE ON PAGE LOAD
           ================================================================== */

        document.addEventListener('DOMContentLoaded', () => {
            SwapWidget.init();
        });

        // Listen for wallet connection changes from parent dashboard
        window.addEventListener('message', (event) => {
        // Validate message origin for security
        if (!isValidMessageOrigin || !isValidMessageOrigin(event)) return;
            if (event.data.type === 'wallet_connected' && event.data.address) {
                console.log('📨 Received wallet connection from parent:', event.data.address);
                SwapWidget.walletAddress = event.data.address;

                // Save to localStorage for persistence
                localStorage.setItem('brofit_wallet_address', event.data.address);

                SwapWidget.updateWalletUI();
            } else if (event.data.type === 'wallet_disconnected') {
                console.log('📨 Received wallet disconnection from parent');
                SwapWidget.walletAddress = null;
                localStorage.removeItem('brofit_wallet_address');
                SwapWidget.updateWalletUI();
            }
        });
    </script>
</body>
</html>
