<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Transaction History | BroFit</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="./shared/styles.css">

    <style>
        /* ====================================================================
           TRANSACTION HISTORY SPECIFIC STYLES
           ================================================================== */

        .history-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        /* Filters Section */
        .filters-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            backdrop-filter: blur(var(--glass-blur));
            margin-bottom: var(--space-xl);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: var(--space-md);
            align-items: end;
        }

        /* Transaction List */
        .transactions-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            backdrop-filter: blur(var(--glass-blur));
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }

        .tx-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* Transaction Card */
        .tx-card {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .tx-card:hover {
            border-color: var(--primary-green);
            transform: translateX(4px);
        }

        .tx-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-md);
        }

        .tx-type-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
        }

        .tx-type-swap {
            background: rgba(62, 184, 95, 0.2);
            color: var(--primary-green);
        }

        .tx-type-bridge {
            background: rgba(100, 210, 255, 0.2);
            color: var(--info);
        }

        .tx-timestamp {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        .tx-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .tx-amount {
            flex: 1;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: var(--font-mono);
        }

        .tx-arrow {
            color: var(--text-tertiary);
            font-size: 20px;
        }

        .tx-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--space-md);
            border-top: 1px solid var(--glass-border);
        }

        .tx-hash {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }

        .status-confirmed {
            background: rgba(48, 209, 88, 0.2);
            color: var(--success);
        }

        .status-pending {
            background: rgba(255, 214, 10, 0.2);
            color: var(--warning);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-failed {
            background: rgba(255, 69, 58, 0.2);
            color: var(--error);
        }

        /* Transaction Detail Modal */
        .tx-detail-modal {
            max-width: 600px;
        }

        .detail-grid {
            display: grid;
            gap: var(--space-lg);
        }

        .detail-section {
            padding: var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .detail-section-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-md);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-family: var(--font-mono);
            text-align: right;
        }

        .detail-value.hash {
            color: var(--primary-green);
            cursor: pointer;
            transition: color var(--transition-base);
        }

        .detail-value.hash:hover {
            color: var(--primary-green-light);
        }

        .detail-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-md);
            margin-top: var(--space-xl);
        }

        .page-info {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .page-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .page-button {
            min-width: 40px;
            height: 40px;
            padding: 0 var(--space-md);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .page-button:hover:not(:disabled) {
            background: var(--glass-bg-hover);
            border-color: var(--primary-green);
        }

        .page-button.active {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }

        .page-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-transactions {
            text-align: center;
            padding: var(--space-3xl);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
            opacity: 0.3;
        }

        .empty-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .empty-description {
            font-size: var(--font-size-md);
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }

            .tx-content {
                flex-direction: column;
                align-items: start;
            }

            .tx-arrow {
                transform: rotate(90deg);
            }

            .tx-footer {
                flex-direction: column;
                gap: var(--space-sm);
                align-items: start;
            }

            .page-buttons {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 414px) {
            .history-container {
                padding: var(--space-md);
            }

            .transactions-section {
                padding: var(--space-lg);
            }

            .tx-card {
                padding: var(--space-md);
            }
        }
    </style>
</head>
<body>
    <div class="history-container">
        <!-- Header -->
        <div class="widget-header">
            <h1 class="widget-title">📜 Transaction History</h1>
            <p class="widget-description">View and manage all your swap and bridge transactions</p>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <input
                    type="text"
                    id="searchTx"
                    class="input input-search"
                    placeholder="Search by transaction hash..."
                >
                <select class="select" id="chainFilter">
                    <option value="all">All Chains</option>
                    <option value="ethereum">Ethereum</option>
                    <option value="polygon">Polygon</option>
                    <option value="bsc">BNB Chain</option>
                </select>
                <select class="select" id="typeFilter">
                    <option value="all">All Types</option>
                    <option value="swap">Swaps</option>
                    <option value="bridge">Bridges</option>
                </select>
                <select class="select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                </select>
                <button class="btn btn-secondary" id="exportBtn">
                    Export CSV
                </button>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="transactions-section">
            <div class="section-header">
                <div class="section-title">Recent Transactions</div>
            </div>

            <div class="tx-list" id="txList">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <div class="page-info" id="pageInfo">Showing 1-10 of 47 transactions</div>
                <div class="page-buttons" id="pageButtons">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-transactions hidden" id="emptyState">
                <div class="empty-icon">📜</div>
                <div class="empty-title">No Transactions Found</div>
                <div class="empty-description">Make your first swap or bridge to see your transaction history</div>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal (hidden initially) -->
    <div class="modal-overlay hidden" id="txModal">
        <div class="modal-content tx-detail-modal">
            <div class="modal-header">
                <h2 class="modal-title">Transaction Details</h2>
                <button class="modal-close" id="closeModal">✕</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid" id="txDetails">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Shared Utilities -->
    <script src="./shared/utils.js"></script>
    <script src="./shared/rocketx-api.js"></script>

    <!-- Transaction History Logic -->
    <script>
        /* ====================================================================
           TRANSACTION HISTORY STATE & CONFIGURATION
           ================================================================== */

        const TransactionHistory = {
            // State
            transactions: [],
            filteredTransactions: [],
            currentPage: 1,
            itemsPerPage: 10,

            // Filters
            filters: {
                search: '',
                chain: 'all',
                type: 'all',
                status: 'all'
            },

            // Mock transaction data
            mockTransactions: [
                {
                    hash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef',
                    type: 'swap',
                    fromAmount: '1.0 ETH',
                    toAmount: '2,500.45 USDC',
                    chain: 'ethereum',
                    status: 'confirmed',
                    timestamp: Date.now() - 3600000,
                    gasFee: '$12.34',
                    block: '19234567'
                },
                {
                    hash: '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890',
                    type: 'bridge',
                    fromAmount: '100 MATIC',
                    toAmount: '~99.8 MATIC',
                    chain: 'polygon',
                    toChain: 'ethereum',
                    status: 'pending',
                    timestamp: Date.now() - 1800000,
                    gasFee: '$5.00',
                    bridgeFee: '$2.50'
                },
                {
                    hash: '0x7890abcdef1234567890abcdef1234567890abcdef1234567890abcdef123456',
                    type: 'swap',
                    fromAmount: '100 USDC',
                    toAmount: '0.04 ETH',
                    chain: 'ethereum',
                    status: 'confirmed',
                    timestamp: Date.now() - 7200000,
                    gasFee: '$8.50',
                    block: '19234500'
                },
                {
                    hash: '0x456789abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234',
                    type: 'bridge',
                    fromAmount: '0.5 BNB',
                    toAmount: '~0.498 BNB',
                    chain: 'bsc',
                    toChain: 'polygon',
                    status: 'failed',
                    timestamp: Date.now() - 10800000,
                    gasFee: '$0.50',
                    error: 'Insufficient liquidity'
                },
                {
                    hash: '0xdef123456789abcdef1234567890abcdef1234567890abcdef1234567890abcd',
                    type: 'swap',
                    fromAmount: '0.5 BNB',
                    toAmount: '25 BUSD',
                    chain: 'bsc',
                    status: 'confirmed',
                    timestamp: Date.now() - 14400000,
                    gasFee: '$0.25',
                    block: '28934567'
                }
            ],

            /* ================================================================
               INITIALIZATION
               ============================================================== */

            async init() {
                console.log('📜 Initializing Transaction History...');

                // Check wallet connection
                this.walletAddress = this.getConnectedWallet();

                if (!this.walletAddress) {
                    console.log('⚠️ No wallet connected - showing empty state');
                    this.showWalletRequiredState();
                    return;
                }

                // Load transactions
                await this.loadTransactions();

                // Setup event listeners
                this.setupEventListeners();

                // Apply filters and render
                this.applyFilters();
                this.renderTransactions();

                console.log('✅ Transaction History initialized');
            },

            /* ================================================================
               WALLET CONNECTION
               ============================================================== */

            getConnectedWallet() {
                // Try to get wallet address from global state or localStorage
                if (window.walletState && window.walletState.address) {
                    return window.walletState.address;
                }

                const stored = localStorage.getItem('brofit_connected_wallet');
                return stored ? JSON.parse(stored).address : null;
            },

            showWalletRequiredState() {
                const emptyState = document.getElementById('emptyState');
                emptyState.querySelector('.empty-title').textContent = 'Connect Your Wallet';
                emptyState.querySelector('.empty-description').innerHTML =
                    'Connect your wallet to view your transaction history<br><br>' +
                    '<button class="btn btn-primary" onclick="window.parent.postMessage({ type: \'CONNECT_WALLET\' }, \'*\')">Connect Wallet</button>';
                emptyState.classList.remove('hidden');

                // Hide filters and pagination
                document.querySelector('.filters-section').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';
            },

            /* ================================================================
               DATA LOADING
               ============================================================== */

            async loadTransactions() {
                try {
                    console.log(`🔄 Loading transactions for ${this.walletAddress}...`);

                    // Try RocketX API first
                    const apiTransactions = await rocketxAPI.getTransactionHistory(
                        this.walletAddress,
                        { limit: 100, type: 'all' }
                    );

                    if (apiTransactions && apiTransactions.length > 0) {
                        console.log(`✅ Loaded ${apiTransactions.length} transactions from RocketX API`);
                        this.transactions = this.normalizeTransactions(apiTransactions);
                        return;
                    }

                    // Fallback to localStorage
                    const localTransactions = this.getLocalTransactions();

                    if (localTransactions && localTransactions.length > 0) {
                        console.log(`✅ Loaded ${localTransactions.length} transactions from localStorage`);
                        this.transactions = localTransactions;
                        return;
                    }

                    // No transactions found - show demo data with banner
                    console.log('ℹ️ No transactions found - showing demo data');
                    this.transactions = this.mockTransactions;
                    this.showDemoBanner();

                } catch (error) {
                    console.error('Failed to load transactions:', error);

                    // Try localStorage fallback
                    const localTransactions = this.getLocalTransactions();
                    if (localTransactions && localTransactions.length > 0) {
                        this.transactions = localTransactions;
                        this.showApiErrorBanner();
                    } else {
                        // Last resort: show mock data with banner
                        this.transactions = this.mockTransactions;
                        this.showDemoBanner();
                    }
                }
            },

            /**
             * Normalize API response to consistent format
             */
            normalizeTransactions(apiTxs) {
                return apiTxs.map(tx => ({
                    hash: tx.hash || tx.txHash || tx.transactionHash,
                    type: tx.type || (tx.bridgeId ? 'bridge' : 'swap'),
                    fromAmount: `${tx.fromAmount || tx.amount} ${tx.fromToken || tx.tokenIn}`,
                    toAmount: `${tx.toAmount || tx.amountOut} ${tx.toToken || tx.tokenOut}`,
                    chain: tx.chain || tx.network || tx.chainId,
                    toChain: tx.toChain || tx.destinationChain,
                    status: tx.status || 'confirmed',
                    timestamp: tx.timestamp || tx.blockTimestamp || Date.now(),
                    gasFee: tx.gasFee || tx.gasUsed || '$0.00',
                    block: tx.blockNumber || tx.block,
                    bridgeFee: tx.bridgeFee,
                    error: tx.error
                }));
            },

            /**
             * Get transactions from localStorage
             */
            getLocalTransactions() {
                const key = `brofit_tx_history_${this.walletAddress.toLowerCase()}`;
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : [];
            },

            /**
             * Show demo mode banner
             */
            showDemoBanner() {
                const banner = document.createElement('div');
                banner.className = 'demo-banner';
                banner.style.cssText = `
                    background: rgba(255, 214, 10, 0.2);
                    border: 1px solid #FFD60A;
                    border-radius: 8px;
                    padding: 12px 16px;
                    margin-bottom: 20px;
                    text-align: center;
                    color: var(--text-primary);
                `;
                banner.innerHTML = '<strong>⚠️ Demo Mode:</strong> Showing sample transactions. Make your first swap or bridge to see real history.';

                document.querySelector('.history-container').insertBefore(
                    banner,
                    document.querySelector('.filters-section')
                );
            },

            /**
             * Show API error banner
             */
            showApiErrorBanner() {
                const banner = document.createElement('div');
                banner.className = 'api-error-banner';
                banner.style.cssText = `
                    background: rgba(255, 159, 10, 0.2);
                    border: 1px solid #FF9F0A;
                    border-radius: 8px;
                    padding: 12px 16px;
                    margin-bottom: 20px;
                    text-align: center;
                    color: var(--text-primary);
                `;
                banner.innerHTML = '<strong>⚠️ API Offline:</strong> Showing cached transactions from browser storage.';

                document.querySelector('.history-container').insertBefore(
                    banner,
                    document.querySelector('.filters-section')
                );
            },

            /* ================================================================
               EVENT HANDLERS
               ============================================================== */

            setupEventListeners() {
                // Search input
                document.getElementById('searchTx').addEventListener('input', debounce((e) => {
                    this.filters.search = e.target.value.trim();
                    this.applyFilters();
                    this.renderTransactions();
                }, 300));

                // Chain filter
                document.getElementById('chainFilter').addEventListener('change', (e) => {
                    this.filters.chain = e.target.value;
                    this.applyFilters();
                    this.renderTransactions();
                });

                // Type filter
                document.getElementById('typeFilter').addEventListener('change', (e) => {
                    this.filters.type = e.target.value;
                    this.applyFilters();
                    this.renderTransactions();
                });

                // Status filter
                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.applyFilters();
                    this.renderTransactions();
                });

                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportToCSV();
                });

                // Modal close
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeModal();
                });
            },

            /* ================================================================
               FILTERING
               ============================================================== */

            applyFilters() {
                this.filteredTransactions = this.transactions.filter(tx => {
                    // Search filter
                    if (this.filters.search) {
                        const query = this.filters.search.toLowerCase();
                        if (!tx.hash.toLowerCase().includes(query)) {
                            return false;
                        }
                    }

                    // Chain filter
                    if (this.filters.chain !== 'all' && tx.chain !== this.filters.chain) {
                        return false;
                    }

                    // Type filter
                    if (this.filters.type !== 'all' && tx.type !== this.filters.type) {
                        return false;
                    }

                    // Status filter
                    if (this.filters.status !== 'all' && tx.status !== this.filters.status) {
                        return false;
                    }

                    return true;
                });

                // Reset to page 1 when filters change
                this.currentPage = 1;
            },

            /* ================================================================
               RENDERING
               ============================================================== */

            renderTransactions() {
                const container = document.getElementById('txList');
                container.innerHTML = '';

                // Show/hide empty state
                const emptyState = document.getElementById('emptyState');
                emptyState.classList.toggle('hidden', this.filteredTransactions.length > 0);

                if (this.filteredTransactions.length === 0) {
                    return;
                }

                // Calculate pagination
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = Math.min(startIndex + this.itemsPerPage, this.filteredTransactions.length);
                const pageTransactions = this.filteredTransactions.slice(startIndex, endIndex);

                // Render transaction cards
                pageTransactions.forEach(tx => {
                    const card = this.createTransactionCard(tx);
                    container.appendChild(card);
                });

                // Update pagination
                this.renderPagination();
            },

            createTransactionCard(tx) {
                const card = document.createElement('div');
                card.className = 'tx-card';

                // Type badge
                const typeBadge = tx.type === 'swap' ? 'tx-type-swap' : 'tx-type-bridge';

                // Status badge
                let statusBadge = '';
                if (tx.status === 'confirmed') {
                    statusBadge = 'status-confirmed">✅ Confirmed';
                } else if (tx.status === 'pending') {
                    statusBadge = 'status-pending">⏳ Pending';
                } else if (tx.status === 'failed') {
                    statusBadge = 'status-failed">❌ Failed';
                }

                card.innerHTML = `
                    <div class="tx-header">
                        <div class="tx-type-badge ${typeBadge}">
                            ${tx.type === 'swap' ? '🔄' : '🌉'} ${tx.type}
                        </div>
                        <div class="tx-timestamp">${formatRelativeTime(tx.timestamp)}</div>
                    </div>
                    <div class="tx-content">
                        <div class="tx-amount">${tx.fromAmount}</div>
                        <div class="tx-arrow">→</div>
                        <div class="tx-amount">${tx.toAmount}</div>
                    </div>
                    <div class="tx-footer">
                        <div class="tx-hash">${formatTxHash(tx.hash)}</div>
                        <div class="status-badge ${statusBadge}</div>
                    </div>
                `;

                // Click to open details
                card.addEventListener('click', () => {
                    this.openTransactionDetails(tx);
                });

                return card;
            },

            renderPagination() {
                const totalPages = Math.ceil(this.filteredTransactions.length / this.itemsPerPage);

                // Update page info
                const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endIndex = Math.min(this.currentPage * this.itemsPerPage, this.filteredTransactions.length);
                document.getElementById('pageInfo').textContent = `Showing ${startIndex}-${endIndex} of ${this.filteredTransactions.length} transactions`;

                // Render page buttons
                const buttonsContainer = document.getElementById('pageButtons');
                buttonsContainer.innerHTML = '';

                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-button';
                prevBtn.textContent = '←';
                prevBtn.disabled = this.currentPage === 1;
                prevBtn.addEventListener('click', () => {
                    this.currentPage--;
                    this.renderTransactions();
                });
                buttonsContainer.appendChild(prevBtn);

                // Page number buttons
                for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                    const btn = document.createElement('button');
                    btn.className = `page-button ${i === this.currentPage ? 'active' : ''}`;
                    btn.textContent = i;
                    btn.addEventListener('click', () => {
                        this.currentPage = i;
                        this.renderTransactions();
                    });
                    buttonsContainer.appendChild(btn);
                }

                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-button';
                nextBtn.textContent = '→';
                nextBtn.disabled = this.currentPage === totalPages;
                nextBtn.addEventListener('click', () => {
                    this.currentPage++;
                    this.renderTransactions();
                });
                buttonsContainer.appendChild(nextBtn);
            },

            /* ================================================================
               TRANSACTION DETAILS MODAL
               ============================================================== */

            openTransactionDetails(tx) {
                const modal = document.getElementById('txModal');
                const detailsContainer = document.getElementById('txDetails');

                // Build details HTML
                detailsContainer.innerHTML = `
                    <div class="detail-section">
                        <div class="detail-section-title">Transaction Info</div>
                        <div class="detail-row">
                            <span class="detail-label">Type</span>
                            <span class="detail-value">${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Date</span>
                            <span class="detail-value">${formatDateTime(tx.timestamp)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">${tx.status.charAt(0).toUpperCase() + tx.status.slice(1)}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-section-title">Trade Details</div>
                        <div class="detail-row">
                            <span class="detail-label">From</span>
                            <span class="detail-value">${tx.fromAmount}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">To</span>
                            <span class="detail-value">${tx.toAmount}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Network</span>
                            <span class="detail-value">${tx.chain.charAt(0).toUpperCase() + tx.chain.slice(1)}</span>
                        </div>
                        ${tx.toChain ? `
                            <div class="detail-row">
                                <span class="detail-label">To Network</span>
                                <span class="detail-value">${tx.toChain.charAt(0).toUpperCase() + tx.toChain.slice(1)}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="detail-section">
                        <div class="detail-section-title">Blockchain Details</div>
                        <div class="detail-row">
                            <span class="detail-label">Transaction Hash</span>
                            <span class="detail-value hash" onclick="copyToClipboard('${tx.hash}')">${formatTxHash(tx.hash)}</span>
                        </div>
                        ${tx.block ? `
                            <div class="detail-row">
                                <span class="detail-label">Block</span>
                                <span class="detail-value">${tx.block}</span>
                            </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-label">Gas Fee</span>
                            <span class="detail-value">${tx.gasFee}</span>
                        </div>
                        ${tx.bridgeFee ? `
                            <div class="detail-row">
                                <span class="detail-label">Bridge Fee</span>
                                <span class="detail-value">${tx.bridgeFee}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="detail-actions">
                        <button class="btn btn-secondary w-full" onclick="window.open('${getExplorerTxUrl(tx.hash, 1)}', '_blank')">
                            View on Explorer
                        </button>
                        ${tx.status === 'failed' ? `
                            <button class="btn btn-primary w-full">
                                Retry Transaction
                            </button>
                        ` : ''}
                    </div>
                `;

                modal.classList.remove('hidden');
            },

            closeModal() {
                document.getElementById('txModal').classList.add('hidden');
            },

            /* ================================================================
               EXPORT FUNCTIONALITY
               ============================================================== */

            exportToCSV() {
                const headers = ['Date/Time', 'Type', 'From', 'To', 'Chain', 'Status', 'Gas Fee', 'TX Hash'];
                const rows = this.filteredTransactions.map(tx => [
                    formatDateTime(tx.timestamp),
                    tx.type,
                    tx.fromAmount,
                    tx.toAmount,
                    tx.chain,
                    tx.status,
                    tx.gasFee,
                    tx.hash
                ]);

                const csv = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transaction_history_${Date.now()}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);

                showNotification('Transaction history exported to CSV', 'success');
            }
        };

        /* ====================================================================
           INITIALIZE ON PAGE LOAD
           ================================================================== */

        document.addEventListener('DOMContentLoaded', () => {
            TransactionHistory.init();
        });
    </script>
</body>
</html>
